# API 代理解决方案

## 问题背景

由于 `/chat` 页面使用的某些外部API（如 dicebear.com 头像服务、价格数据API等）存在国外IP限制，导致用户在某些地区无法正常获取数据，页面出现错误。

## 解决方案

实现了一套完整的API代理系统，通过服务器后端代理外部API调用，解决IP限制问题并提供了强大的缓存和降级策略。

## 架构设计

### 1. API代理配置 (`lib/api-proxy-config.ts`)

统一管理所有需要代理的外部API配置，包括：
- 超时设置
- 缓存时间
- 重试策略
- 用户代理配置

### 2. 头像代理服务 (`/api/avatar-proxy`)

**原始问题：** 前端直接调用 `https://api.dicebear.com/7.x/pixel-art/svg`
**解决方案：** 
- 后端代理头像生成API
- 24小时缓存
- 失败时返回默认SVG头像
- 使用路径：`/api/avatar-proxy?seed=username`

### 3. 价格数据代理 (`/api/mainstream-prices`)

**功能增强：**
- 多级缓存策略（主缓存10分钟，备用缓存1小时）
- 异步后台更新，不阻塞用户请求
- 静态备用数据作为最后降级方案
- 智能数据源切换

### 4. 代币信息代理 (`/api/token-info`)

**功能增强：**
- 主API（PancakeSwap）+ 备选API（1inch）
- 5分钟缓存
- 失败时返回基本代币信息
- 支持多个数据源切换

## 缓存策略

### 三级缓存系统

1. **主缓存** - 短时间缓存（5-10分钟）
   - 提供最新数据
   - 定期后台更新

2. **备用缓存** - 长时间缓存（1小时）
   - 当主缓存过期或更新失败时使用
   - 提供相对新鲜的数据

3. **静态备用数据** - 永久可用
   - 当所有外部API都不可用时的最后方案
   - 确保应用始终可用

## 错误处理

### 渐进式降级策略

1. **尝试主要API** → 成功则更新缓存
2. **主API失败** → 尝试备选API
3. **备选API失败** → 使用缓存数据
4. **缓存过期** → 使用静态备用数据
5. **完全失败** → 返回基本信息，不破坏用户体验

## 性能优化

### 1. 异步更新
- 缓存过期时不等待API响应
- 立即返回备用数据
- 后台异步更新缓存

### 2. 智能缓存
- 根据API稳定性设置不同缓存时间
- 失败后增加重试间隔
- 避免频繁请求失败的API

### 3. 超时控制
- 10秒API超时限制
- 避免长时间等待
- 快速切换到备选方案

## 代码修改

### 前端修改

```tsx
// 之前：直接调用外部API
<img src="https://api.dicebear.com/7.x/pixel-art/svg?seed=default" />

// 现在：使用本地代理
<img src="/api/avatar-proxy?seed=default" />
```

### 后端代理

```ts
// 统一的代理请求配置
const config = getProxyRequestConfig(API_PROXY_CONFIG.avatar.timeout);
const response = await fetch(externalApiUrl, config);
```

## 监控和日志

### 日志记录
- API调用状态
- 缓存命中/未命中
- 错误信息和降级策略触发

### 数据源标识
```json
{
  "data": {...},
  "source": "primary_cache",
  "cache_age": "120秒",
  "cached": true
}
```

## 测试验证

运行测试脚本验证代理功能：

```bash
node test-api-proxy.js
```

测试覆盖：
- ✅ 头像代理API
- ✅ 价格数据API  
- ✅ 代币信息API

## 扩展性

### 添加新的API代理

1. 在 `api-proxy-config.ts` 中添加配置
2. 创建对应的 `/api/xxx-proxy` 路由
3. 实现缓存和降级策略
4. 更新前端调用

### 支持更多外部服务

系统设计允许轻松添加更多需要代理的外部API，只需遵循相同的模式即可。

## 效果

✅ **解决IP限制问题** - 用户通过本地服务器访问外部API
✅ **提高可用性** - 多级缓存确保服务稳定
✅ **改善性能** - 缓存减少网络请求
✅ **增强体验** - 降级策略保证功能可用
✅ **便于维护** - 统一配置管理所有外部API 